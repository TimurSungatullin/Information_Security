# coding=utf-8

import hashlib

from Crypto.Cipher import AES

from swapKey import Client

p = ('ffffffffffffffffc90fdaa22168c234c4c6628b80dc1cd129024e088a67cc74020bbea6'
     '3b139b22514a08798e3404ddef9519b3cd3a431b302b0a6df25f14374fe1356d6d51c245'
     'e485b576625e7ec6f44c42e9a637ed6b0bff5cb6f406b7edee386bfb5a899fa5ae9f2411'
     '7c4b1fe649286651ece45b3dc2007cb8a163bf0598da48361c55d39a69163fa8fd24cf5f'
     '83655d23dca3ad961c62f356208552bb9ed529077096966d670c354e4abc9804f1746c08'
     'ca237327ffffffffffffffff')
g = 5
p = int(p, 16)

print u'Man in the Middle'
A = Client(p, g)
B = Client()

print u'A send: p: {}..., g: {}, A: {}...'.format(A.p, A.g, A.my_key)
print u'B recv: p: {}..., g: {}, p: {}...'.format(A.p, A.g, A.p)
A.send(B, data=(A.p, A.g, A.p))
print u'B send: B: {}'.format(B.my_key)
print u'A recv: p: {}...'.format(B.p)
B.send(A, data=(B.p, ))
# Если True, клиенты получили одинаковые ключи
print A.final_key == B.final_key
msg = b'Message for Bob!'
encr_msg = A.send(B, msg=msg)
# Из-за нашей подстановки, можем вычислить ключ и расшифровать сообщение.
# На последнем шаге, мы отправили A значение p, это значение он вовзвёл в степень a
# и взял модуль по p, то есть p ^ a % p, а это равно 0, потому что p ^ a делится
# на p без остатка (Как и p). То есть ключ равен 0
iv = encr_msg[-AES.block_size:]
msg = encr_msg[:-AES.block_size]
sha1_key = hashlib.sha1(hex(0L)).hexdigest()[:16]
aes = AES.new(sha1_key, mode=AES.MODE_CBC, IV=iv)
decrypted_msg = aes.decrypt(msg)
print 'Расшифровка'
print decrypted_msg
# Перенаправим это сообщение
B.send(A, msg=bytes(decrypted_msg))

"""
Man in the Middle
A send: p: 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919..., g: 5, A: 866961985147873364337249899074551839906919827789160226244753674703806536684389154492565187527467131552061950199206741619102551728514962728498992779481790303742779214812648270181292663558439205548383794538828050112765549866574045725246894020513232983732681716610208787522387142199606168583194237715619873168516883840411625944274494083940246750932622941225443458396896785409530033965512780723949643096345345645664963745209539276294463024007917343927598666241245716...
B recv: p: 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919..., g: 5, p: 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919...
B send: B: 125
A recv: p: 2410312426921032588552076022197566074856950548502459942654116941958108831682612228890093858261341614673227141477904012196503648957050582631942730706805009223062734745341073406696246014589361659774041027169249453200378729434170325843778659198143763193776859869524088940195577346119843545301547043747207749969763750084308926339295559968882457872412993810129130294592999947926365264059284647209730384947211681434464714438488520940127459844288859336526896320919633919...
True
Client get the message
Message for Bob!
Расшифровка
Message for Bob!
Client get the message
Message for Bob!
"""


